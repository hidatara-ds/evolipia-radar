<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <meta name="theme-color" content="#0f172a" />
  <base href="/" />
  <title>Evolipia Radar</title>

  <!-- App Icons / Favicons -->
  <link rel="icon" type="image/png" href="/assets/icon.png" />
  <link rel="apple-touch-icon" href="/assets/icon1.png" />

  <!-- External CSS -->
  <link rel="stylesheet" href="/web/style.css" />
</head>

<body>
  <header class="header">
    <div class="brand">
      <!-- ikon kecil di atas (logo/app icon) -->
      <img class="app-logo" src="/assets/icon.png" alt="Evolipia Radar" />
      <h1>Evolipia Radar</h1>
    </div>

    <div class="header-actions">
      <button class="icon-btn" onclick="refreshCurrentPanel()" title="Refresh" aria-label="Refresh">üîÑ</button>
    </div>
  </header>

  <nav class="nav">
    <button type="button" class="nav-btn active" data-panel="feed">
      <span class="icon">üì∞</span>
      <span>Feed</span>
    </button>
    <button type="button" class="nav-btn" data-panel="rising">
      <span class="icon">üî•</span>
      <span>Trending</span>
    </button>
    <button type="button" class="nav-btn" data-panel="search">
      <span class="icon">üîç</span>
      <span>Cari</span>
    </button>
    <button type="button" class="nav-btn" data-panel="chat">
      <span class="icon">üí¨</span>
      <span>AI Chat</span>
    </button>
    <button type="button" class="nav-btn" data-panel="settings">
      <span class="icon">‚öôÔ∏è</span>
      <span>Atur</span>
    </button>
  </nav>

  <main>
    <!-- Feed Panel -->
    <section id="panel-feed" class="panel active">
      <div class="panel-header">
        <h2>Top Hari Ini</h2>
        <p class="panel-subtitle">Berita & tren terpopuler</p>
      </div>

      <div class="ptr-indicator" id="feed-ptr">‚¨áÔ∏è Tarik untuk refresh</div>
      <div id="feed-list" class="item-list"></div>
    </section>

    <!-- Rising Panel -->
    <section id="panel-rising" class="panel">
      <div class="panel-header">
        <h2>Sedang Naik</h2>
        <p class="panel-subtitle">Tren yang momentumnya naik</p>
      </div>
      <div id="rising-list" class="item-list"></div>
    </section>

    <!-- Search Panel -->
    <section id="panel-search" class="panel">
      <div class="search-container">
        <form class="search-form" id="searchForm" onsubmit="return false;">
          <input type="search" id="searchQ" placeholder="Cari tren, topik, atau kata kunci..." autocomplete="off" />
          <button type="button" id="searchSubmitBtn" aria-label="Search">üîç</button>
        </form>
      </div>
      <div id="search-list" class="item-list"></div>
    </section>

    <!-- Chat Panel -->
    <section id="panel-chat" class="panel">
      <div class="chat-container">
        <ul id="chat-messages" class="chat-messages"></ul>

        <form id="chatForm" class="chat-input-row" onsubmit="return false;">
          <div class="chat-input-container">
            <input type="text" id="chatInput" placeholder="Tanyakan apa saja..." autocomplete="off" />
            <button type="button" id="chatSubmitBtn" aria-label="Send">‚¨ÜÔ∏è</button>
          </div>
        </form>
      </div>
    </section>

    <!-- Settings Panel -->
    <section id="panel-settings" class="panel">
      <div class="panel-header">
        <h2>Pengaturan</h2>
        <p class="panel-subtitle">Konfigurasi aplikasi</p>
      </div>

      <div class="settings-section">
        <h3>AI Configuration</h3>
        <div class="settings-item" onclick="showApiKeyModal()">
          <span class="settings-item-label">API Key OpenRouter</span>
          <span class="settings-item-value" id="apiKeyStatus">
            <span class="source-status off">‚ö†Ô∏è Belum diatur</span>
          </span>
        </div>
        <div class="settings-item" onclick="clearChatHistory()">
          <span class="settings-item-label">Hapus Riwayat Chat</span>
          <span class="settings-item-value">üóëÔ∏è</span>
        </div>
      </div>

      <div class="settings-section">
        <h3>Tentang</h3>
        <div class="settings-item">
          <span class="settings-item-label">Versi</span>
          <span class="settings-item-value">2.0.0</span>
        </div>
        <div class="settings-item">
          <span class="settings-item-label">Evolipia Radar</span>
          <span class="settings-item-value">AI Trend Aggregator</span>
        </div>
      </div>
    </section>
  </main>

  <!-- Item Detail Overlay -->
  <div id="item-detail" class="overlay hidden">
    <div class="overlay-header">
      <div class="back" onclick="closeDetail()">‚Üê</div>
      <span style="font-weight: 600;">Detail</span>
    </div>
    <div class="overlay-content" id="item-detail-body"></div>
  </div>

  <!-- API Key Modal -->
  <div id="apiKeyModal" class="modal-overlay" onclick="if(event.target === this) hideApiKeyModal()">
    <div class="modal">
      <h3>üîë API Key OpenRouter</h3>
      <p>Masukkan API key dari OpenRouter untuk mengaktifkan fitur chat AI. Key disimpan lokal di device Anda.</p>
      <input type="password" id="apiKeyInput" class="modal-input" placeholder="sk-or-v1-..." />
      <div class="modal-buttons">
        <button class="modal-btn secondary" onclick="hideApiKeyModal()">Batal</button>
        <button class="modal-btn primary" onclick="saveApiKey()">Simpan</button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast"></div>

  <script>
    // Configuration
    const API_BASE = '';
    const STORAGE_KEY = 'evolipia_settings';

    // Assets paths (biar gampang ganti nantinya)
    const ASSETS = {
      appIcon: '/assets/icon.png',
      appIconAlt: '/assets/icon1.png',
      mascot: '/assets/maskot1.png' // maskot wajib tampil di AI chat
    };

    // State
    let settings = {
      openrouterKey: localStorage.getItem('openrouter_key') || ''
    };

    let chatHistory = JSON.parse(localStorage.getItem('chat_history') || '[]');
    let currentPanel = 'feed';
    let isLoading = false;

    // API URL helper
    function apiUrl(path) {
      return (API_BASE + path).replace(/\/+/g, '/');
    }

    // UI Helpers
    function showToast(message, type = 'info') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = `toast ${type}`;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 3000);
    }

    function escapeHtml(s) {
      if (s == null) return '';
      const div = document.createElement('div');
      div.textContent = s;
      return div.innerHTML;
    }

    function formatDate(s) {
      if (!s) return '';
      try {
        const d = new Date(s);
        const now = new Date();
        const diff = now - d;
        const minutes = Math.floor(diff / 60000);
        const hours = Math.floor(diff / 3600000);
        const days = Math.floor(diff / 86400000);

        if (minutes < 1) return 'Baru saja';
        if (minutes < 60) return `${minutes}m lalu`;
        if (hours < 24) return `${hours}j lalu`;
        if (days < 7) return `${days}h lalu`;

        return d.toLocaleDateString('id-ID', { day: 'numeric', month: 'short' });
      } catch (_) {
        return s;
      }
    }

    // Navigation
    function showPanel(id) {
      document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
      document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));

      const panel = document.getElementById('panel-' + id);
      if (panel) panel.classList.add('active');

      const btn = document.querySelector(`.nav-btn[data-panel="${id}"]`);
      if (btn) btn.classList.add('active');

      currentPanel = id;
      onShowPanel(id);
    }

    function onShowPanel(panelId) {
      if (panelId === 'feed') loadFeed();
      else if (panelId === 'rising') loadRising();
      else if (panelId === 'chat') initChat();
      else if (panelId === 'settings') updateSettingsUI();
    }

    function refreshCurrentPanel() {
      onShowPanel(currentPanel);
      showToast('Dimuat ulang', 'success');
    }

    // Data Loading
    async function loadFeed() {
      const container = document.getElementById('feed-list');
      if (container.children.length === 0 || container.querySelector('.loading')) {
        container.innerHTML = '<div class="loading"><div class="spinner"></div>Memuat berita...</div>';
      }

      try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 10000);

        const r = await fetch(apiUrl('/v1/feed?date=today'), {
          signal: controller.signal,
          cache: 'no-cache'
        });
        clearTimeout(timeoutId);

        if (!r.ok) throw new Error('Server error');
        const data = await r.json();

        const items = data.items || [];
        if (items.length === 0) {
          container.innerHTML = `
            <div class="empty">
              <div class="empty-icon">üì≠</div>
              <div>Belum ada berita hari ini</div>
              <div style="font-size: 0.85rem; margin-top: 8px;">Coba lagi nanti</div>
            </div>
          `;
          return;
        }

        container.innerHTML = items.map(it => itemCard(it)).join('');
      } catch (e) {
        container.innerHTML = `
          <div class="empty">
            <div class="empty-icon">‚ö†Ô∏è</div>
            <div>Gagal memuat data</div>
            <div style="font-size: 0.85rem; margin-top: 8px;">${escapeHtml(e.message)}</div>
          </div>
        `;
      }
    }

    async function loadRising() {
      const container = document.getElementById('rising-list');
      container.innerHTML = '<div class="loading"><div class="spinner"></div>Mendeteksi tren...</div>';

      try {
        const r = await fetch(apiUrl('/v1/rising?window=2h'));
        if (!r.ok) throw new Error('Server error');
        const data = await r.json();

        const items = data.items || [];
        if (items.length === 0) {
          container.innerHTML = `
            <div class="empty">
              <div class="empty-icon">üìä</div>
              <div>Belum ada data tren</div>
            </div>
          `;
          return;
        }

        container.innerHTML = items.map(it => itemCard(it, true)).join('');
      } catch (e) {
        container.innerHTML = `
          <div class="empty">
            <div class="empty-icon">‚ö†Ô∏è</div>
            <div>Gagal memuat tren</div>
          </div>
        `;
      }
    }

    function itemCard(it, isRising = false) {
      const score = isRising
        ? (it.rising_score != null ? `üî• ${Math.round(it.rising_score)}` : '')
        : (it.scores?.final != null ? `‚≠ê ${it.scores.final.toFixed(1)}` : '');

      const summary = it.summary?.tldr || '';

      // Mini icon di kartu (dashboard/feed)
      const domainIcon = `
        <div class="card-badge">
          <img class="badge-icon" src="${ASSETS.appIcon}" alt="icon" />
        </div>
      `;

      return `
        <li class="item-card" data-id="${escapeHtml(it.id)}" onclick="openItemDetail('${escapeHtml(it.id)}')">
          ${domainIcon}
          <div class="title">${escapeHtml(it.title)}</div>
          <div class="meta">
            <span>${escapeHtml(it.domain || 'Unknown')}</span>
            <span class="meta-dot"></span>
            <span>${formatDate(it.published_at)}</span>
          </div>
          ${score ? `<div class="score">${score}</div>` : ''}
          ${summary ? `<div class="summary">${escapeHtml(summary.slice(0, 140))}${summary.length > 140 ? '...' : ''}</div>` : ''}
        </li>
      `;
    }

    // Search
    function handleSearch() {
      const q = document.getElementById('searchQ').value.trim();
      if (!q) return;

      const list = document.getElementById('search-list');
      list.innerHTML = '<div class="loading"><div class="spinner"></div>Mencari...</div>';

      fetch(apiUrl('/v1/search?q=' + encodeURIComponent(q)))
        .then(r => {
          if (!r.ok) throw new Error('Search failed');
          return r.json();
        })
        .then(data => {
          const items = data.items || [];
          if (items.length === 0) {
            list.innerHTML = `
              <div class="empty">
                <div class="empty-icon">üîç</div>
                <div>Tidak ada hasil untuk "${escapeHtml(q)}"</div>
              </div>
            `;
          } else {
            list.innerHTML = items.map(it => itemCard(it)).join('');
          }
        })
        .catch(() => {
          list.innerHTML = `
            <div class="empty">
              <div class="empty-icon">‚ö†Ô∏è</div>
              <div>Pencarian gagal</div>
            </div>
          `;
        });
    }

    // Detail View
    async function openItemDetail(id) {
      const overlay = document.getElementById('item-detail');
      const body = document.getElementById('item-detail-body');

      body.innerHTML = '<div class="loading"><div class="spinner"></div>Memuat detail...</div>';
      overlay.classList.remove('hidden');
      document.body.style.overflow = 'hidden';

      try {
        const r = await fetch(apiUrl('/v1/items/' + encodeURIComponent(id)));
        if (!r.ok) throw new Error('Failed to load');
        const it = await r.json();

        body.innerHTML = `
          <h2>${escapeHtml(it.title)}</h2>
          <a class="link" href="${escapeHtml(it.url)}" target="_blank" rel="noopener">
            üîó ${escapeHtml(it.domain || 'Link')}
          </a>

          <div class="block">
            <label>Informasi</label>
            <div class="block-content">
              <div style="margin-bottom: 8px;"><strong>Domain:</strong> ${escapeHtml(it.domain || '-')}</div>
              <div><strong>Kategori:</strong> ${escapeHtml(it.category || '-')}</div>
              <div style="margin-top: 8px; color: var(--muted); font-size: 0.85rem;">
                Dipublikasikan: ${formatDate(it.published_at)}
              </div>
            </div>
          </div>

          ${it.summary ? `
            <div class="block">
              <label>Ringkasan</label>
              <div class="block-content">${escapeHtml(it.summary.tldr || '')}</div>
              ${it.summary.why_it_matters ? `
                <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border);">
                  <div style="font-weight: 600; margin-bottom: 4px;">Mengapa penting:</div>
                  ${escapeHtml(it.summary.why_it_matters)}
                </div>
              ` : ''}
            </div>
          ` : ''}

          ${it.scores ? `
            <div class="block">
              <label>Analisis Skor</label>
              <div class="block-content">
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; text-align: center;">
                  <div style="padding: 12px; background: var(--bg); border-radius: 8px;">
                    <div style="font-size: 1.25rem; font-weight: 700; color: var(--accent);">${it.scores.final.toFixed(1)}</div>
                    <div style="font-size: 0.75rem; color: var(--muted); margin-top: 4px;">Final</div>
                  </div>
                  <div style="padding: 12px; background: var(--bg); border-radius: 8px;">
                    <div style="font-size: 1.25rem; font-weight: 700; color: var(--warning);">${it.scores.hot.toFixed(1)}</div>
                    <div style="font-size: 0.75rem; color: var(--muted); margin-top: 4px;">Hot</div>
                  </div>
                  <div style="padding: 12px; background: var(--bg); border-radius: 8px;">
                    <div style="font-size: 1.25rem; font-weight: 700; color: var(--success);">${it.scores.relevance.toFixed(1)}</div>
                    <div style="font-size: 0.75rem; color: var(--muted); margin-top: 4px;">Relevan</div>
                  </div>
                </div>
              </div>
            </div>
          ` : ''}
        `;
      } catch (e) {
        body.innerHTML = `
          <div class="empty">
            <div class="empty-icon">‚ö†Ô∏è</div>
            <div>Gagal memuat detail</div>
            <div style="font-size: 0.85rem; margin-top: 8px;">${escapeHtml(e.message)}</div>
          </div>
        `;
      }
    }

    function closeDetail() {
      document.getElementById('item-detail').classList.add('hidden');
      document.body.style.overflow = '';
    }

    // Chat System
    const SYSTEM_PROMPT = `Kamu adalah Evolipia Radar AI ‚Äî asisten pintar untuk aplikasi radar tren.

KARAKTER:
- Bicara dalam Bahasa Indonesia natural, friendly, tapi profesional
- Respons singkat & padat (maksimal 3-4 kalimat kecuali diminta detail)
- Gunakan bullet points untuk list
- Fokus pada tren, teknologi, dan insight data

KEMAMPUAN:
- Jelaskan tren/sinyal yang sedang naik
- Berikan rekomendasi aksi berdasarkan data
- Ringkas artikel panjang jadi poin-poin kunci
- Bantu analisis kompetitor atau market

JAWAB LANGSUNG tanpa basa-basi.`;

    function initChat() {
      renderChatMessages();
      updateChatInputState();
    }

    function renderChatMessages() {
      const el = document.getElementById('chat-messages');

      if (chatHistory.length === 0) {
        el.innerHTML = `
          <div class="chat-welcome">
            <img class="chat-mascot" src="${ASSETS.mascot}" alt="Maskot Evolipia" />
            <div class="chat-welcome-title">Evolipia AI Assistant</div>
            <div class="chat-welcome-sub">Tanyakan tentang tren, berita, atau minta analisis data.</div>
          </div>
        `;
        return;
      }

      el.innerHTML = chatHistory.map(m => {
        const isAssistant = m.role === 'assistant';
        return `
          <li class="chat-row ${m.role}">
            ${isAssistant ? `
              <div class="chat-avatar">
                <img src="${ASSETS.mascot}" alt="Maskot" />
              </div>
            ` : ''}

            <div class="chat-msg ${m.role}${m.error ? ' error' : ''}">
              ${isAssistant ? '<div class="role">Evolipia AI</div>' : ''}
              <div class="chat-text">${escapeHtml(m.content)}</div>
            </div>
          </li>
        `;
      }).join('');

      el.scrollTop = el.scrollHeight;
    }

    function appendMessage(role, content, isError = false) {
      chatHistory.push({ role, content, error: isError, time: Date.now() });
      if (chatHistory.length > 50) chatHistory.shift();
      localStorage.setItem('chat_history', JSON.stringify(chatHistory));
      renderChatMessages();
    }

    function showTyping() {
      const el = document.getElementById('chat-messages');
      const typingId = 'typing-' + Date.now();

      const typingHtml = `
        <li class="chat-row assistant" id="${typingId}">
          <div class="chat-avatar">
            <img src="${ASSETS.mascot}" alt="Maskot" />
          </div>
          <div class="chat-msg assistant">
            <div class="role">Evolipia AI</div>
            <div class="typing-indicator">
              <span></span><span></span><span></span>
            </div>
          </div>
        </li>
      `;

      if (chatHistory.length === 0) {
        el.innerHTML = typingHtml;
      } else {
        el.insertAdjacentHTML('beforeend', typingHtml);
      }

      el.scrollTop = el.scrollHeight;
      return typingId;
    }

    function removeTyping(id) {
      const el = document.getElementById(id);
      if (el) el.remove();
    }

    async function handleChatSubmit() {
      if (!settings.openrouterKey) {
        showToast('API Key belum diatur', 'error');
        showApiKeyModal();
        return;
      }

      const input = document.getElementById('chatInput');
      const btn = document.getElementById('chatSubmitBtn');
      const text = input.value.trim();

      if (!text || isLoading) return;

      input.value = '';
      input.disabled = true;
      btn.disabled = true;
      isLoading = true;

      appendMessage('user', text);
      const typingId = showTyping();

      try {
        const messages = [
          { role: 'system', content: SYSTEM_PROMPT },
          ...chatHistory.slice(-10).map(m => ({ role: m.role, content: m.content }))
        ];

        const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${settings.openrouterKey}`,
            'HTTP-Referer': window.location.origin,
            'X-Title': 'Evolipia Radar'
          },
          body: JSON.stringify({
            model: 'openai/gpt-3.5-turbo',
            messages: messages,
            max_tokens: 500,
            temperature: 0.7
          })
        });

        removeTyping(typingId);

        if (!response.ok) {
          const error = await response.json().catch(() => ({}));
          throw new Error(error.error?.message || 'API Error');
        }

        const data = await response.json();
        const reply = data.choices?.[0]?.message?.content || 'Maaf, tidak ada respons.';

        appendMessage('assistant', reply);
      } catch (err) {
        removeTyping(typingId);
        appendMessage('assistant', `Error: ${err.message}. Coba periksa API key atau coba lagi.`, true);
      } finally {
        input.disabled = false;
        btn.disabled = false;
        isLoading = false;
        input.focus();
      }
    }

    function updateChatInputState() {
      const input = document.getElementById('chatInput');
      const btn = document.getElementById('chatSubmitBtn');

      if (!settings.openrouterKey) {
        input.placeholder = 'üîí Atur API Key dulu di Pengaturan';
        input.disabled = true;
        btn.disabled = true;
      } else {
        input.placeholder = 'Tanyakan apa saja...';
        input.disabled = false;
        btn.disabled = false;
      }
    }

    function clearChatHistory() {
      if (!confirm('Hapus semua riwayat chat?')) return;
      chatHistory = [];
      localStorage.removeItem('chat_history');
      renderChatMessages();
      showToast('Riwayat dihapus', 'success');
    }

    // Settings & API Key
    function updateSettingsUI() {
      const statusEl = document.getElementById('apiKeyStatus');
      if (settings.openrouterKey) {
        const masked = settings.openrouterKey.slice(0, 8) + '...' + settings.openrouterKey.slice(-4);
        statusEl.innerHTML = `<span class="source-status on">‚úì ${masked}</span>`;
      } else {
        statusEl.innerHTML = `<span class="source-status off">‚ö†Ô∏è Belum diatur</span>`;
      }
    }

    function showApiKeyModal() {
      document.getElementById('apiKeyInput').value = settings.openrouterKey;
      document.getElementById('apiKeyModal').classList.add('show');
    }

    function hideApiKeyModal() {
      document.getElementById('apiKeyModal').classList.remove('show');
    }

    function saveApiKey() {
      const key = document.getElementById('apiKeyInput').value.trim();
      if (key) {
        settings.openrouterKey = key;
        localStorage.setItem('openrouter_key', key);
        showToast('API Key disimpan', 'success');
      } else {
        settings.openrouterKey = '';
        localStorage.removeItem('openrouter_key');
        showToast('API Key dihapus', 'info');
      }
      hideApiKeyModal();
      updateSettingsUI();
      updateChatInputState();
    }

    // Initialization
    function init() {
      // Nav buttons
      document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const panelId = btn.dataset.panel;
          if (panelId) showPanel(panelId);
        });
      });

      // Search
      document.getElementById('searchSubmitBtn').addEventListener('click', handleSearch);
      document.getElementById('searchQ').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') handleSearch();
      });

      // Chat
      document.getElementById('chatSubmitBtn').addEventListener('click', handleChatSubmit);
      document.getElementById('chatInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          handleChatSubmit();
        }
      });

      // Pull to refresh simulation
      let touchStartY = 0;
      const feedPanel = document.getElementById('panel-feed');

      feedPanel.addEventListener('touchstart', (e) => {
        if (feedPanel.scrollTop === 0) {
          touchStartY = e.touches[0].clientY;
        }
      }, { passive: true });

      feedPanel.addEventListener('touchmove', (e) => {
        if (feedPanel.scrollTop === 0) {
          const diff = e.touches[0].clientY - touchStartY;
          if (diff > 60) {
            document.getElementById('feed-ptr').classList.add('show');
          }
        }
      }, { passive: true });

      feedPanel.addEventListener('touchend', () => {
        const ptr = document.getElementById('feed-ptr');
        if (ptr.classList.contains('show')) {
          ptr.classList.remove('show');
          loadFeed();
          showToast('Dimuat ulang', 'success');
        }
      });

      // Initial load
      updateSettingsUI();
      loadFeed();
    }

    // Start
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  </script>
</body>
</html>