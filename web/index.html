<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <meta name="theme-color" content="#0f172a" />
  <base href="/" />
  <title>Evolipia Radar</title>
  <style>
    :root {
      --bg: #0b0f19;
      --surface: #151b2b;
      --surface-hover: #1e2538;
      --border: #2a3447;
      --text: #f8fafc;
      --muted: #94a3b8;
      --accent: #38bdf8;
      --accent-dim: #0284c7;
      --danger: #ef4444;
      --success: #22c55e;
      --warning: #f59e0b;
      --nav-h: 64px;
      --header-h: 56px;
      --safe-bottom: env(safe-area-inset-bottom, 0);
      --safe-top: env(safe-area-inset-top, 0);
    }
    
    * { 
      box-sizing: border-box; 
      -webkit-tap-highlight-color: transparent;
    }
    
    html {
      scroll-behavior: smooth;
    }
    
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100dvh;
      max-width: 430px;
      margin-left: auto;
      margin-right: auto;
      position: relative;
      overflow-x: hidden;
    }

    /* Scrollbar styling */
    ::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }
    ::-webkit-scrollbar-track {
      background: transparent;
    }
    ::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 3px;
    }
    ::-webkit-scrollbar-thumb:hover {
      background: var(--muted);
    }

    /* Header */
    .header {
      position: fixed;
      top: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 100%;
      max-width: 430px;
      height: calc(var(--header-h) + var(--safe-top));
      padding-top: var(--safe-top);
      z-index: 100;
      background: rgba(11, 15, 25, 0.95);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding-left: 16px;
      padding-right: 16px;
    }
    
    .header h1 { 
      margin: 0; 
      font-size: 1.1rem; 
      font-weight: 700;
      background: linear-gradient(135deg, var(--text) 0%, var(--accent) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .header-actions {
      display: flex;
      gap: 8px;
    }

    .icon-btn {
      width: 36px;
      height: 36px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: var(--surface);
      color: var(--muted);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 1.1rem;
    }

    .icon-btn:active {
      transform: scale(0.95);
      background: var(--surface-hover);
    }

    /* Main content */
    main {
      padding-top: calc(var(--header-h) + var(--safe-top) + 8px);
      padding-bottom: calc(var(--nav-h) + var(--safe-bottom) + 16px);
      min-height: 100dvh;
    }

    /* Navigation */
    .nav {
      position: fixed;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 100%;
      max-width: 430px;
      height: calc(var(--nav-h) + var(--safe-bottom));
      padding-bottom: var(--safe-bottom);
      background: rgba(21, 27, 43, 0.98);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border-top: 1px solid var(--border);
      display: flex;
      justify-content: space-around;
      align-items: center;
      z-index: 100;
    }
    
    .nav-btn {
      flex: 1;
      height: 100%;
      padding: 8px 4px;
      background: none;
      border: none;
      color: var(--muted);
      font-size: 0.65rem;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 4px;
      transition: all 0.2s;
      position: relative;
    }
    
    .nav-btn.active { 
      color: var(--accent); 
      font-weight: 600;
    }

    .nav-btn.active::before {
      content: '';
      position: absolute;
      top: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 20px;
      height: 3px;
      background: var(--accent);
      border-radius: 0 0 4px 4px;
    }
    
    .nav-btn .icon { 
      font-size: 1.3rem;
      transition: transform 0.2s;
    }

    .nav-btn:active .icon {
      transform: scale(0.9);
    }

    /* Panels */
    .panel { 
      display: none; 
      padding: 16px;
      animation: fadeIn 0.3s ease;
    }
    
    .panel.active { 
      display: block; 
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .panel-header {
      margin-bottom: 16px;
    }
    
    .panel h2 { 
      font-size: 1.25rem; 
      font-weight: 700;
      margin: 0 0 4px 0;
      color: var(--text);
    }

    .panel-subtitle {
      font-size: 0.875rem;
      color: var(--muted);
      margin: 0;
    }

    /* Cards */
    .item-list { 
      list-style: none; 
      padding: 0; 
      margin: 0;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .item-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 16px;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
      overflow: hidden;
    }
    
    .item-card::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 3px;
      background: var(--accent);
      opacity: 0;
      transition: opacity 0.2s;
    }
    
    .item-card:active { 
      transform: scale(0.98);
      background: var(--surface-hover);
    }

    .item-card:hover::before,
    .item-card:active::before {
      opacity: 1;
    }
    
    .item-card .title { 
      font-weight: 600; 
      font-size: 0.95rem; 
      margin: 0 0 8px 0; 
      line-height: 1.4;
      color: var(--text);
    }
    
    .item-card .meta { 
      font-size: 0.8rem; 
      color: var(--muted);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .item-card .meta-dot {
      width: 4px;
      height: 4px;
      background: var(--muted);
      border-radius: 50%;
    }
    
    .item-card .score { 
      display: inline-flex;
      align-items: center;
      gap: 4px;
      margin-top: 10px;
      padding: 4px 10px;
      background: rgba(56, 189, 248, 0.1);
      color: var(--accent);
      font-size: 0.75rem;
      font-weight: 600;
      border-radius: 20px;
      border: 1px solid rgba(56, 189, 248, 0.2);
    }

    .item-card .summary {
      font-size: 0.85rem;
      color: var(--muted);
      margin-top: 10px;
      line-height: 1.5;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    
    .empty { 
      text-align: center; 
      color: var(--muted); 
      padding: 48px 24px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
    }

    .empty-icon {
      font-size: 3rem;
      opacity: 0.5;
    }
    
    .loading { 
      text-align: center; 
      color: var(--muted); 
      padding: 48px 24px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 16px;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Search */
    .search-container {
      position: sticky;
      top: 0;
      z-index: 10;
      background: var(--bg);
      padding-bottom: 16px;
      margin-bottom: 8px;
    }

    .search-form { 
      display: flex; 
      gap: 10px;
    }
    
    .search-form input {
      flex: 1;
      padding: 14px 18px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--surface);
      color: var(--text);
      font-size: 1rem;
      outline: none;
      transition: all 0.2s;
    }

    .search-form input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(56, 189, 248, 0.1);
    }
    
    .search-form button {
      padding: 14px 20px;
      border-radius: 12px;
      border: none;
      background: var(--accent);
      color: var(--bg);
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .search-form button:active {
      transform: scale(0.95);
      background: var(--accent-dim);
    }

    /* Item detail overlay */
    .overlay {
      position: fixed;
      inset: 0;
      background: var(--bg);
      z-index: 200;
      overflow-y: auto;
      max-width: 430px;
      margin-left: auto;
      margin-right: auto;
      animation: slideUp 0.3s ease;
    }

    @keyframes slideUp {
      from { transform: translateY(100%); }
      to { transform: translateY(0); }
    }
    
    .overlay.hidden { 
      display: none; 
    }

    .overlay-header {
      position: sticky;
      top: 0;
      background: rgba(11, 15, 25, 0.95);
      backdrop-filter: blur(12px);
      border-bottom: 1px solid var(--border);
      padding: 12px 16px;
      display: flex;
      align-items: center;
      gap: 12px;
      z-index: 10;
    }
    
    .overlay .back { 
      width: 36px;
      height: 36px;
      border-radius: 10px;
      background: var(--surface);
      border: 1px solid var(--border);
      color: var(--text);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 1.2rem;
      transition: all 0.2s;
    }

    .overlay .back:active {
      background: var(--surface-hover);
      transform: scale(0.95);
    }
    
    .overlay-content {
      padding: 20px 16px 100px;
    }
    
    .overlay h2 { 
      font-size: 1.25rem; 
      margin: 0 0 16px 0; 
      line-height: 1.4;
      font-weight: 700;
    }

    .overlay .link { 
      color: var(--accent); 
      word-break: break-all; 
      font-size: 0.9rem;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 12px;
      background: rgba(56, 189, 248, 0.1);
      border-radius: 8px;
      border: 1px solid rgba(56, 189, 248, 0.2);
      margin-bottom: 20px;
    }
    
    .overlay .block { 
      margin-bottom: 24px;
      padding: 16px;
      background: var(--surface);
      border-radius: 12px;
      border: 1px solid var(--border);
    }
    
    .overlay .block label { 
      font-size: 0.75rem; 
      color: var(--muted); 
      display: block; 
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 600;
    }

    .overlay .block-content {
      font-size: 0.95rem;
      line-height: 1.6;
      color: var(--text);
    }

    /* Sources */
    .source-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .source-card .name { 
      font-weight: 600;
      font-size: 0.95rem;
      margin-bottom: 4px;
    }
    
    .source-card .type { 
      font-size: 0.8rem; 
      color: var(--muted); 
    }
    
    .source-status {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .source-status.on {
      background: rgba(34, 197, 94, 0.1);
      color: var(--success);
    }

    .source-status.off {
      background: rgba(148, 163, 184, 0.1);
      color: var(--muted);
    }

    /* Chat - Redesigned */
    .chat-container {
      display: flex;
      flex-direction: column;
      height: calc(100dvh - var(--header-h) - var(--safe-top) - var(--nav-h) - var(--safe-bottom) - 32px);
      position: relative;
    }

    .chat-messages { 
      flex: 1;
      overflow-y: auto;
      padding: 0 4px;
      margin: 0 0 16px 0;
      list-style: none;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .chat-msg { 
      max-width: 85%;
      padding: 12px 16px;
      border-radius: 18px;
      font-size: 0.95rem;
      line-height: 1.5;
      position: relative;
      animation: messageSlide 0.3s ease;
    }

    @keyframes messageSlide {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .chat-msg.user { 
      background: var(--accent);
      color: var(--bg);
      margin-left: auto;
      border-bottom-right-radius: 4px;
      font-weight: 500;
    }
    
    .chat-msg.assistant { 
      background: var(--surface);
      border: 1px solid var(--border);
      color: var(--text);
      margin-right: auto;
      border-bottom-left-radius: 4px;
    }

    .chat-msg.error {
      background: rgba(239, 68, 68, 0.1);
      border-color: var(--danger);
      color: var(--danger);
    }
    
    .chat-msg .role { 
      font-size: 0.7rem; 
      margin-bottom: 6px;
      opacity: 0.7;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .chat-input-container {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 24px;
      padding: 4px;
      display: flex;
      align-items: flex-end;
      gap: 4px;
      max-height: 120px;
    }
    
    .chat-input-row { 
      display: flex;
      gap: 8px;
      width: 100%;
      align-items: flex-end;
    }
    
    .chat-input-row input { 
      flex: 1;
      padding: 12px 16px;
      border-radius: 20px;
      border: none;
      background: transparent;
      color: var(--text);
      font-size: 1rem;
      outline: none;
      max-height: 100px;
      min-height: 44px;
    }

    .chat-input-row input::placeholder {
      color: var(--muted);
    }
    
    .chat-input-row button { 
      width: 44px;
      height: 44px;
      border-radius: 50%;
      border: none;
      background: var(--accent);
      color: var(--bg);
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      flex-shrink: 0;
    }

    .chat-input-row button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .chat-input-row button:not(:disabled):active {
      transform: scale(0.95);
      background: var(--accent-dim);
    }

    .chat-welcome {
      text-align: center;
      padding: 40px 20px;
      color: var(--muted);
    }

    .chat-welcome-icon {
      font-size: 3rem;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    .typing-indicator {
      display: flex;
      gap: 4px;
      padding: 16px;
      align-items: center;
    }

    .typing-indicator span {
      width: 8px;
      height: 8px;
      background: var(--muted);
      border-radius: 50%;
      animation: typing 1.4s infinite;
    }

    .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
    .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }

    @keyframes typing {
      0%, 60%, 100% { transform: translateY(0); }
      30% { transform: translateY(-10px); }
    }

    /* Settings */
    .settings-section { 
      margin-bottom: 24px;
      background: var(--surface);
      border-radius: 16px;
      border: 1px solid var(--border);
      overflow: hidden;
    }
    
    .settings-section h3 { 
      font-size: 0.8rem; 
      color: var(--muted); 
      margin: 0;
      padding: 16px 16px 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .settings-item {
      padding: 16px;
      border-top: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      transition: background 0.2s;
    }

    .settings-item:active {
      background: var(--surface-hover);
    }

    .settings-item:first-of-type {
      border-top: none;
    }

    .settings-item-label {
      font-size: 0.95rem;
      color: var(--text);
    }

    .settings-item-value {
      font-size: 0.85rem;
      color: var(--muted);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* Toast notification */
    .toast {
      position: fixed;
      top: calc(var(--header-h) + var(--safe-top) + 16px);
      left: 50%;
      transform: translateX(-50%) translateY(-100px);
      background: var(--surface);
      color: var(--text);
      padding: 12px 20px;
      border-radius: 12px;
      border: 1px solid var(--border);
      box-shadow: 0 10px 40px rgba(0,0,0,0.4);
      z-index: 1000;
      opacity: 0;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 0.9rem;
      max-width: 90%;
    }

    .toast.show {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }

    .toast.error {
      border-color: var(--danger);
      color: var(--danger);
    }

    .toast.success {
      border-color: var(--success);
      color: var(--success);
    }

    /* API Key Modal */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.8);
      backdrop-filter: blur(4px);
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s;
    }

    .modal-overlay.show {
      opacity: 1;
      pointer-events: auto;
    }

    .modal {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 24px;
      width: 100%;
      max-width: 360px;
      transform: scale(0.9);
      transition: transform 0.3s;
    }

    .modal-overlay.show .modal {
      transform: scale(1);
    }

    .modal h3 {
      margin: 0 0 8px 0;
      font-size: 1.2rem;
    }

    .modal p {
      color: var(--muted);
      font-size: 0.9rem;
      margin: 0 0 20px 0;
      line-height: 1.5;
    }

    .modal-input {
      width: 100%;
      padding: 14px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--bg);
      color: var(--text);
      font-size: 0.9rem;
      margin-bottom: 16px;
      font-family: monospace;
    }

    .modal-input:focus {
      outline: none;
      border-color: var(--accent);
    }

    .modal-buttons {
      display: flex;
      gap: 10px;
    }

    .modal-btn {
      flex: 1;
      padding: 14px;
      border-radius: 12px;
      border: none;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .modal-btn.primary {
      background: var(--accent);
      color: var(--bg);
    }

    .modal-btn.secondary {
      background: transparent;
      color: var(--muted);
      border: 1px solid var(--border);
    }

    .modal-btn:active {
      transform: scale(0.98);
    }

    /* Pull to refresh indicator */
    .ptr-indicator {
      text-align: center;
      padding: 20px;
      color: var(--muted);
      font-size: 0.9rem;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .ptr-indicator.show {
      opacity: 1;
    }
  </style>
</head>
<body>
  <header class="header">
    <h1>üéØ Evolipia Radar</h1>
    <div class="header-actions">
      <button class="icon-btn" onclick="refreshCurrentPanel()" title="Refresh">üîÑ</button>
    </div>
  </header>

  <nav class="nav">
    <button type="button" class="nav-btn active" data-panel="feed">
      <span class="icon">üì∞</span>
      <span>Feed</span>
    </button>
    <button type="button" class="nav-btn" data-panel="rising">
      <span class="icon">üî•</span>
      <span>Trending</span>
    </button>
    <button type="button" class="nav-btn" data-panel="search">
      <span class="icon">üîç</span>
      <span>Cari</span>
    </button>
    <button type="button" class="nav-btn" data-panel="chat">
      <span class="icon">üí¨</span>
      <span>AI Chat</span>
    </button>
    <button type="button" class="nav-btn" data-panel="settings">
      <span class="icon">‚öôÔ∏è</span>
      <span>Atur</span>
    </button>
  </nav>

  <main>
    <!-- Feed Panel -->
    <section id="panel-feed" class="panel active">
      <div class="panel-header">
        <h2>Top Hari Ini</h2>
        <p class="panel-subtitle">Berita & tren terpopuler</p>
      </div>
      <div class="ptr-indicator" id="feed-ptr">‚¨áÔ∏è Tarik untuk refresh</div>
      <div id="feed-list" class="item-list"></div>
    </section>

    <!-- Rising Panel -->
    <section id="panel-rising" class="panel">
      <div class="panel-header">
        <h2>Sedang Naik</h2>
        <p class="panel-subtitle">Tren yang momentumnya naik</p>
      </div>
      <div id="rising-list" class="item-list"></div>
    </section>

    <!-- Search Panel -->
    <section id="panel-search" class="panel">
      <div class="search-container">
        <form class="search-form" id="searchForm" onsubmit="return false;">
          <input type="search" id="searchQ" placeholder="Cari tren, topik, atau kata kunci..." autocomplete="off" />
          <button type="button" id="searchSubmitBtn">üîç</button>
        </form>
      </div>
      <div id="search-list" class="item-list"></div>
    </section>

    <!-- Chat Panel -->
    <section id="panel-chat" class="panel">
      <div class="chat-container">
        <ul id="chat-messages" class="chat-messages"></ul>
        <form id="chatForm" class="chat-input-row" onsubmit="return false;">
          <div class="chat-input-container">
            <input type="text" id="chatInput" placeholder="Tanyakan apa saja..." autocomplete="off" />
            <button type="button" id="chatSubmitBtn">‚¨ÜÔ∏è</button>
          </div>
        </form>
      </div>
    </section>

    <!-- Settings Panel -->
    <section id="panel-settings" class="panel">
      <div class="panel-header">
        <h2>Pengaturan</h2>
        <p class="panel-subtitle">Konfigurasi aplikasi</p>
      </div>
      
      <div class="settings-section">
        <h3>AI Configuration</h3>
        <div class="settings-item" onclick="showApiKeyModal()">
          <span class="settings-item-label">API Key OpenRouter</span>
          <span class="settings-item-value" id="apiKeyStatus">
            <span class="source-status off">‚ö†Ô∏è Belum diatur</span>
          </span>
        </div>
        <div class="settings-item" onclick="clearChatHistory()">
          <span class="settings-item-label">Hapus Riwayat Chat</span>
          <span class="settings-item-value">üóëÔ∏è</span>
        </div>
      </div>

      <div class="settings-section">
        <h3>Tentang</h3>
        <div class="settings-item">
          <span class="settings-item-label">Versi</span>
          <span class="settings-item-value">2.0.0</span>
        </div>
        <div class="settings-item">
          <span class="settings-item-label">Evolipia Radar</span>
          <span class="settings-item-value">AI Trend Aggregator</span>
        </div>
      </div>
    </section>
  </main>

  <!-- Item Detail Overlay -->
  <div id="item-detail" class="overlay hidden">
    <div class="overlay-header">
      <div class="back" onclick="closeDetail()">‚Üê</div>
      <span style="font-weight: 600;">Detail</span>
    </div>
    <div class="overlay-content" id="item-detail-body"></div>
  </div>

  <!-- API Key Modal -->
  <div id="apiKeyModal" class="modal-overlay" onclick="if(event.target === this) hideApiKeyModal()">
    <div class="modal">
      <h3>üîë API Key OpenRouter</h3>
      <p>Masukkan API key dari OpenRouter untuk mengaktifkan fitur chat AI. Key disimpan lokal di device Anda.</p>
      <input type="password" id="apiKeyInput" class="modal-input" placeholder="sk-or-v1-..." />
      <div class="modal-buttons">
        <button class="modal-btn secondary" onclick="hideApiKeyModal()">Batal</button>
        <button class="modal-btn primary" onclick="saveApiKey()">Simpan</button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast"></div>

  <script>
    // Configuration
    const API_BASE = '';
    const STORAGE_KEY = 'evolipia_settings';
    
    // State
    let settings = {
      openrouterKey: localStorage.getItem('openrouter_key') || ''
    };
    
    let chatHistory = JSON.parse(localStorage.getItem('chat_history') || '[]');
    let currentPanel = 'feed';
    let isLoading = false;

    // API URL helper
    function apiUrl(path) { 
      return (API_BASE + path).replace(/\/+/g, '/'); 
    }

    // UI Helpers
    function showToast(message, type = 'info') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = `toast ${type}`;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 3000);
    }

    function escapeHtml(s) {
      if (s == null) return '';
      const div = document.createElement('div');
      div.textContent = s;
      return div.innerHTML;
    }

    function formatDate(s) {
      if (!s) return '';
      try {
        const d = new Date(s);
        const now = new Date();
        const diff = now - d;
        const minutes = Math.floor(diff / 60000);
        const hours = Math.floor(diff / 3600000);
        const days = Math.floor(diff / 86400000);
        
        if (minutes < 1) return 'Baru saja';
        if (minutes < 60) return `${minutes}m lalu`;
        if (hours < 24) return `${hours}j lalu`;
        if (days < 7) return `${days}h lalu`;
        
        return d.toLocaleDateString('id-ID', { day: 'numeric', month: 'short' });
      } catch (_) { 
        return s; 
      }
    }

    // Navigation
    function showPanel(id) {
      document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
      document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
      
      const panel = document.getElementById('panel-' + id);
      if (panel) panel.classList.add('active');
      
      const btn = document.querySelector(`.nav-btn[data-panel="${id}"]`);
      if (btn) btn.classList.add('active');
      
      currentPanel = id;
      onShowPanel(id);
    }

    function onShowPanel(panelId) {
      if (panelId === 'feed') loadFeed();
      else if (panelId === 'rising') loadRising();
      else if (panelId === 'chat') initChat();
      else if (panelId === 'settings') updateSettingsUI();
    }

    function refreshCurrentPanel() {
      onShowPanel(currentPanel);
      showToast('Dimuat ulang', 'success');
    }

    // Data Loading
    async function loadFeed() {
      const container = document.getElementById('feed-list');
      if (container.children.length === 0 || container.querySelector('.loading')) {
        container.innerHTML = '<div class="loading"><div class="spinner"></div>Memuat berita...</div>';
      }
      
      try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 10000);
        
        const r = await fetch(apiUrl('/v1/feed?date=today'), {
          signal: controller.signal,
          cache: 'no-cache'
        });
        clearTimeout(timeoutId);
        
        if (!r.ok) throw new Error('Server error');
        const data = await r.json();
        
        const items = data.items || [];
        if (items.length === 0) {
          container.innerHTML = `
            <div class="empty">
              <div class="empty-icon">üì≠</div>
              <div>Belum ada berita hari ini</div>
              <div style="font-size: 0.85rem; margin-top: 8px;">Coba lagi nanti</div>
            </div>
          `;
          return;
        }
        
        container.innerHTML = items.map(it => itemCard(it)).join('');
      } catch (e) {
        container.innerHTML = `
          <div class="empty">
            <div class="empty-icon">‚ö†Ô∏è</div>
            <div>Gagal memuat data</div>
            <div style="font-size: 0.85rem; margin-top: 8px;">${escapeHtml(e.message)}</div>
          </div>
        `;
      }
    }

    async function loadRising() {
      const container = document.getElementById('rising-list');
      container.innerHTML = '<div class="loading"><div class="spinner"></div>Mendeteksi tren...</div>';
      
      try {
        const r = await fetch(apiUrl('/v1/rising?window=2h'));
        if (!r.ok) throw new Error('Server error');
        const data = await r.json();
        
        const items = data.items || [];
        if (items.length === 0) {
          container.innerHTML = `
            <div class="empty">
              <div class="empty-icon">üìä</div>
              <div>Belum ada data tren</div>
            </div>
          `;
          return;
        }
        
        container.innerHTML = items.map(it => itemCard(it, true)).join('');
      } catch (e) {
        container.innerHTML = `
          <div class="empty">
            <div class="empty-icon">‚ö†Ô∏è</div>
            <div>Gagal memuat tren</div>
          </div>
        `;
      }
    }

    function itemCard(it, isRising = false) {
      const score = isRising 
        ? (it.rising_score != null ? `üî• ${Math.round(it.rising_score)}` : '')
        : (it.scores?.final != null ? `‚≠ê ${it.scores.final.toFixed(1)}` : '');
      
      const summary = it.summary?.tldr || '';
      
      return `
        <li class="item-card" data-id="${escapeHtml(it.id)}" onclick="openItemDetail('${escapeHtml(it.id)}')">
          <div class="title">${escapeHtml(it.title)}</div>
          <div class="meta">
            <span>${escapeHtml(it.domain || 'Unknown')}</span>
            <span class="meta-dot"></span>
            <span>${formatDate(it.published_at)}</span>
          </div>
          ${score ? `<div class="score">${score}</div>` : ''}
          ${summary ? `<div class="summary">${escapeHtml(summary.slice(0, 140))}${summary.length > 140 ? '...' : ''}</div>` : ''}
        </li>
      `;
    }

    // Search
    function handleSearch() {
      const q = document.getElementById('searchQ').value.trim();
      if (!q) return;
      
      const list = document.getElementById('search-list');
      list.innerHTML = '<div class="loading"><div class="spinner"></div>Mencari...</div>';
      
      fetch(apiUrl('/v1/search?q=' + encodeURIComponent(q)))
        .then(r => {
          if (!r.ok) throw new Error('Search failed');
          return r.json();
        })
        .then(data => {
          const items = data.items || [];
          if (items.length === 0) {
            list.innerHTML = `
              <div class="empty">
                <div class="empty-icon">üîç</div>
                <div>Tidak ada hasil untuk "${escapeHtml(q)}"</div>
              </div>
            `;
          } else {
            list.innerHTML = items.map(it => itemCard(it)).join('');
          }
        })
        .catch(e => {
          list.innerHTML = `
            <div class="empty">
              <div class="empty-icon">‚ö†Ô∏è</div>
              <div>Pencarian gagal</div>
            </div>
          `;
        });
    }

    // Detail View
    async function openItemDetail(id) {
      const overlay = document.getElementById('item-detail');
      const body = document.getElementById('item-detail-body');
      
      body.innerHTML = '<div class="loading"><div class="spinner"></div>Memuat detail...</div>';
      overlay.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
      
      try {
        const r = await fetch(apiUrl('/v1/items/' + encodeURIComponent(id)));
        if (!r.ok) throw new Error('Failed to load');
        const it = await r.json();
        
        body.innerHTML = `
          <h2>${escapeHtml(it.title)}</h2>
          <a class="link" href="${escapeHtml(it.url)}" target="_blank" rel="noopener">
            üîó ${escapeHtml(it.domain || 'Link')}
          </a>
          
          <div class="block">
            <label>Informasi</label>
            <div class="block-content">
              <div style="margin-bottom: 8px;"><strong>Domain:</strong> ${escapeHtml(it.domain || '-')}</div>
              <div><strong>Kategori:</strong> ${escapeHtml(it.category || '-')}</div>
              <div style="margin-top: 8px; color: var(--muted); font-size: 0.85rem;">
                Dipublikasikan: ${formatDate(it.published_at)}
              </div>
            </div>
          </div>
          
          ${it.summary ? `
            <div class="block">
              <label>Ringkasan</label>
              <div class="block-content">${escapeHtml(it.summary.tldr || '')}</div>
              ${it.summary.why_it_matters ? `
                <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border);">
                  <div style="font-weight: 600; margin-bottom: 4px;">Mengapa penting:</div>
                  ${escapeHtml(it.summary.why_it_matters)}
                </div>
              ` : ''}
            </div>
          ` : ''}
          
          ${it.scores ? `
            <div class="block">
              <label>Analisis Skor</label>
              <div class="block-content">
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; text-align: center;">
                  <div style="padding: 12px; background: var(--bg); border-radius: 8px;">
                    <div style="font-size: 1.25rem; font-weight: 700; color: var(--accent);">${it.scores.final.toFixed(1)}</div>
                    <div style="font-size: 0.75rem; color: var(--muted); margin-top: 4px;">Final</div>
                  </div>
                  <div style="padding: 12px; background: var(--bg); border-radius: 8px;">
                    <div style="font-size: 1.25rem; font-weight: 700; color: var(--warning);">${it.scores.hot.toFixed(1)}</div>
                    <div style="font-size: 0.75rem; color: var(--muted); margin-top: 4px;">Hot</div>
                  </div>
                  <div style="padding: 12px; background: var(--bg); border-radius: 8px;">
                    <div style="font-size: 1.25rem; font-weight: 700; color: var(--success);">${it.scores.relevance.toFixed(1)}</div>
                    <div style="font-size: 0.75rem; color: var(--muted); margin-top: 4px;">Relevan</div>
                  </div>
                </div>
              </div>
            </div>
          ` : ''}
        `;
      } catch (e) {
        body.innerHTML = `
          <div class="empty">
            <div class="empty-icon">‚ö†Ô∏è</div>
            <div>Gagal memuat detail</div>
            <div style="font-size: 0.85rem; margin-top: 8px;">${escapeHtml(e.message)}</div>
          </div>
        `;
      }
    }

    function closeDetail() {
      document.getElementById('item-detail').classList.add('hidden');
      document.body.style.overflow = '';
    }

    // Chat System
    const SYSTEM_PROMPT = `Kamu adalah Evolipia Radar AI ‚Äî asisten pintar untuk aplikasi radar tren. 

KARAKTER:
- Bicara dalam Bahasa Indonesia natural, friendly, tapi profesional
- Respons singkat & padat (maksimal 3-4 kalimat kecuali diminta detail)
- Gunakan bullet points untuk list
- Fokus pada tren, teknologi, dan insight data

KEMAMPUAN:
- Jelaskan tren/sinyal yang sedang naik
- Berikan rekomendasi aksi berdasarkan data
- Ringkas artikel panjang jadi poin-poin kunci
- Bantu analisis kompetitor atau market

JAWAB LANGSUNG tanpa basa-basi.`;

    function initChat() {
      renderChatMessages();
      updateChatInputState();
    }

    function renderChatMessages() {
      const el = document.getElementById('chat-messages');
      
      if (chatHistory.length === 0) {
        el.innerHTML = `
          <div class="chat-welcome">
            <div class="chat-welcome-icon">ü§ñ</div>
            <div style="font-weight: 600; margin-bottom: 8px;">Evolipia AI Assistant</div>
            <div>Tanyakan tentang tren, berita, atau minta analisis data.</div>
          </div>
        `;
        return;
      }
      
      el.innerHTML = chatHistory.map(m => `
        <li class="chat-msg ${m.role}${m.error ? ' error' : ''}">
          ${m.role === 'assistant' ? '<div class="role">Evolipia AI</div>' : ''}
          <div>${escapeHtml(m.content)}</div>
        </li>
      `).join('');
      
      el.scrollTop = el.scrollHeight;
    }

    function appendMessage(role, content, isError = false) {
      chatHistory.push({ role, content, error: isError, time: Date.now() });
      if (chatHistory.length > 50) chatHistory.shift();
      localStorage.setItem('chat_history', JSON.stringify(chatHistory));
      renderChatMessages();
    }

    function showTyping() {
      const el = document.getElementById('chat-messages');
      const typingId = 'typing-' + Date.now();
      
      const typingHtml = `
        <li class="chat-msg assistant" id="${typingId}">
          <div class="role">Evolipia AI</div>
          <div class="typing-indicator">
            <span></span><span></span><span></span>
          </div>
        </li>
      `;
      
      if (chatHistory.length === 0) {
        el.innerHTML = typingHtml;
      } else {
        el.insertAdjacentHTML('beforeend', typingHtml);
      }
      
      el.scrollTop = el.scrollHeight;
      return typingId;
    }

    function removeTyping(id) {
      const el = document.getElementById(id);
      if (el) el.remove();
    }

    async function handleChatSubmit() {
      if (!settings.openrouterKey) {
        showToast('API Key belum diatur', 'error');
        showApiKeyModal();
        return;
      }

      const input = document.getElementById('chatInput');
      const btn = document.getElementById('chatSubmitBtn');
      const text = input.value.trim();
      
      if (!text || isLoading) return;
      
      input.value = '';
      input.disabled = true;
      btn.disabled = true;
      isLoading = true;
      
      appendMessage('user', text);
      const typingId = showTyping();
      
      try {
        const messages = [
          { role: 'system', content: SYSTEM_PROMPT },
          ...chatHistory.slice(-10).map(m => ({ role: m.role, content: m.content }))
        ];
        
        const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${settings.openrouterKey}`,
            'HTTP-Referer': window.location.origin,
            'X-Title': 'Evolipia Radar'
          },
          body: JSON.stringify({
            model: 'openai/gpt-3.5-turbo',
            messages: messages,
            max_tokens: 500,
            temperature: 0.7
          })
        });
        
        removeTyping(typingId);
        
        if (!response.ok) {
          const error = await response.json().catch(() => ({}));
          throw new Error(error.error?.message || 'API Error');
        }
        
        const data = await response.json();
        const reply = data.choices?.[0]?.message?.content || 'Maaf, tidak ada respons.';
        
        appendMessage('assistant', reply);
      } catch (err) {
        removeTyping(typingId);
        appendMessage('assistant', `Error: ${err.message}. Coba periksa API key atau coba lagi.`, true);
      } finally {
        input.disabled = false;
        btn.disabled = false;
        isLoading = false;
        input.focus();
      }
    }

    function updateChatInputState() {
      const input = document.getElementById('chatInput');
      const btn = document.getElementById('chatSubmitBtn');
      
      if (!settings.openrouterKey) {
        input.placeholder = 'üîí Atur API Key dulu di Pengaturan';
        input.disabled = true;
        btn.disabled = true;
      } else {
        input.placeholder = 'Tanyakan apa saja...';
        input.disabled = false;
        btn.disabled = false;
      }
    }

    function clearChatHistory() {
      if (!confirm('Hapus semua riwayat chat?')) return;
      chatHistory = [];
      localStorage.removeItem('chat_history');
      renderChatMessages();
      showToast('Riwayat dihapus', 'success');
    }

    // Settings & API Key
    function updateSettingsUI() {
      const statusEl = document.getElementById('apiKeyStatus');
      if (settings.openrouterKey) {
        const masked = settings.openrouterKey.slice(0, 8) + '...' + settings.openrouterKey.slice(-4);
        statusEl.innerHTML = `<span class="source-status on">‚úì ${masked}</span>`;
      } else {
        statusEl.innerHTML = `<span class="source-status off">‚ö†Ô∏è Belum diatur</span>`;
      }
    }

    function showApiKeyModal() {
      document.getElementById('apiKeyInput').value = settings.openrouterKey;
      document.getElementById('apiKeyModal').classList.add('show');
    }

    function hideApiKeyModal() {
      document.getElementById('apiKeyModal').classList.remove('show');
    }

    function saveApiKey() {
      const key = document.getElementById('apiKeyInput').value.trim();
      if (key) {
        settings.openrouterKey = key;
        localStorage.setItem('openrouter_key', key);
        showToast('API Key disimpan', 'success');
      } else {
        settings.openrouterKey = '';
        localStorage.removeItem('openrouter_key');
        showToast('API Key dihapus', 'info');
      }
      hideApiKeyModal();
      updateSettingsUI();
      updateChatInputState();
    }

    // Initialization
    function init() {
      // Nav buttons
      document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const panelId = btn.dataset.panel;
          if (panelId) showPanel(panelId);
        });
      });
      
      // Search
      document.getElementById('searchSubmitBtn').addEventListener('click', handleSearch);
      document.getElementById('searchQ').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') handleSearch();
      });
      
      // Chat
      document.getElementById('chatSubmitBtn').addEventListener('click', handleChatSubmit);
      document.getElementById('chatInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          handleChatSubmit();
        }
      });
      
      // Pull to refresh simulation
      let touchStartY = 0;
      const feedPanel = document.getElementById('panel-feed');
      
      feedPanel.addEventListener('touchstart', (e) => {
        if (feedPanel.scrollTop === 0) {
          touchStartY = e.touches[0].clientY;
        }
      }, { passive: true });
      
      feedPanel.addEventListener('touchmove', (e) => {
        if (feedPanel.scrollTop === 0) {
          const diff = e.touches[0].clientY - touchStartY;
          if (diff > 60) {
            document.getElementById('feed-ptr').classList.add('show');
          }
        }
      }, { passive: true });
      
      feedPanel.addEventListener('touchend', (e) => {
        const ptr = document.getElementById('feed-ptr');
        if (ptr.classList.contains('show')) {
          ptr.classList.remove('show');
          loadFeed();
          showToast('Dimuat ulang', 'success');
        }
      });
      
      // Initial load
      updateSettingsUI();
      loadFeed();
    }

    // Start
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  </script>
</body>
</html>