version: '3.8'

services:
  # ============================================
  # MLflow - Experiment Tracking
  # ============================================
  mlflow:
    image: ghcr.io/mlflow/mlflow:v2.9.2
    container_name: mlflow
    ports:
      - "5000:5000"
    environment:
      - MLFLOW_TRACKING_URI=sqlite:///mlflow/mlflow.db
      - MLFLOW_DEFAULT_ARTIFACT_ROOT=/mlflow/artifacts
    volumes:
      - mlflow-data:/mlflow
    command: >
      mlflow server
      --backend-store-uri sqlite:///mlflow/mlflow.db
      --default-artifact-root /mlflow/artifacts
      --host 0.0.0.0
      --port 5000
    networks:
      - ml
    restart: unless-stopped

  # ============================================
  # MinIO - S3-compatible Object Storage
  # ============================================
  minio:
    image: minio/minio:RELEASE.2024-01-13T07-53-03Z
    container_name: minio
    ports:
      - "9000:9000"
      - "9001:9001"
    environment:
      - MINIO_ROOT_USER=minioadmin
      - MINIO_ROOT_PASSWORD=minioadmin
    volumes:
      - minio-data:/data
    command: server /data --console-address ":9001"
    networks:
      - ml
    restart: unless-stopped

  # ============================================
  # Jupyter Notebook
  # ============================================
  jupyter:
    image: jupyter/datascience-notebook:latest
    container_name: jupyter
    ports:
      - "8888:8888"
    environment:
      - JUPYTER_ENABLE_LAB=yes
      - MLFLOW_TRACKING_URI=http://mlflow:5000
    volumes:
      - ./ml/notebooks:/home/jovyan/notebooks
      - ./ml/data:/home/jovyan/data
    command: >
      start-notebook.sh
      --NotebookApp.token=''
      --NotebookApp.password=''
    networks:
      - ml
    restart: unless-stopped

  # ============================================
  # Redis - Caching & Message Queue
  # ============================================
  redis:
    image: redis:7-alpine
    container_name: redis
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    networks:
      - ml
    restart: unless-stopped

volumes:
  mlflow-data:
  minio-data:
  redis-data:

networks:
  ml:
    driver: bridge
